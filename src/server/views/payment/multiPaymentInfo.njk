{% extends 'layouts/default.layout.njk' %}

{% set pageTitle = t.site_title %}
{% set pageBreadcrumbItems = [
    { text: t.breadcrumbs.home, url: '/' },
    { text: t.breadcrumbs.pay_dvsa_fine, url: '/' },
    { text: t.breadcrumbs.find_payment_code, url: '/payment-code' },
    { text: t.breadcrumbs.fines_summary }
  ] 
%}
{# This is going to be refactored once the Payment service is integrated and we have full knowledge of the payload
  coming from it.
#}
{% set paid = true if paymentStatus == 'PAID' else false %}

{% block content %}
  
  {% call components.gridRow() %}
    {% call components.columnTwoThirds() %}
      {{ components.heading(text=t.penalty_details_page.penalty_details_title, tag='h1', size='large') }}
      {% if paid == false %}
        {{ components.paragraph(text=t.penalty_details_page.intro_part_paid) }}
      {% else %}
        {{ components.paragraph(text=t.penalty_details_page.intro_paid) }}
      {% endif %}
      {# Penalty details summary table #}
      <table class="details multipenalty-summary-table">
        <tbody>
          <tr>
            <td>{{ t.penalty_details.payment_code }}</td>
            <td colspan=4>{{ paymentCode }}</td>
          </tr>
          <tr>
            <td>{{ t.penalty_details.vehicle_reg }}</td>
            {% if isPenaltyGroup == false %}
              <td>{{ penaltyDetails.vehicleReg if penaltyDetails.complete else t.penalty_details.not_available }}</td>
            {% else %}
              <td>{{ penaltyGroupDetails.registrationNumber if penaltyGroupDetails.registrationNumber else 'N/A' }}</td>
            {% endif %}
          </tr>
          <tr>
            <td>{{ t.penalty_details.penalty_date }}</td>
            {% if isPenaltyGroup == false %}
              <td>{{ penaltyDetails.issueDate if penaltyDetails.complete else 'Not available' }}</td>
            {% else %}
              <td colspan=4>{{ penaltyGroupDetails.date }}</td>
            {% endif %}
          </tr>
          <tr>
            <td>{{ t.penalty_details.location }}</td>
            {% if isPenaltyGroup == false %}
              <td>{{ penaltyDetails.location if penaltyDetails.complete else 'Not available' }}</td> 
            {% else %}
              <td colspan=4>{{ penaltyGroupDetails.location }}</td>
            {% endif %}
          </tr>
          {% if isPenaltyGroup == false %}
            <tr>
              <td>{{ t.penalty_details.amount }}</td>
              <td>&pound;{{ penaltyDetails.amount }}</td>
            </tr>
          {% else %}
            {% for amount in penaltyGroupDetails.splitAmounts|sort(attribute='type', reverse=true) %}
              {% set amountPaid = true if amount.status == 'PAID' else false %}
              {% set statusClass = 'confirmed' if amountPaid else 'unconfirmed' %}
              {% set showPaymentButton = amount.status == 'UNPAID' %}
              <tr class='no-border'>
                <td>
                  {% if amount.type == 'FPN' %}
                    {{ t.penalty_details.type_fixed_penalty }}
                  {% elif amount.type == 'CDN' %}
                    {{ t.penalty_details.type_court_deposit }}
                  {% elif amount.type == 'IM' %}
                    {{ t.penalty_details.type_immobilisation }}
                  {% endif %}
                </td>
                <td>
                  &pound;{{ amount.amount }}
                </td>
                <td>
                  <span class="{{statusClass}}">
                    {% if amountPaid %}
                      <strong>{{ t.penalty_details.status_paid }}</strong> &nbsp;&nbsp;
                      <img src="{{ assets }}/images/icon-check.png" />
                    {% else %}
                      <strong>{{ t.penalty_details.status_unpaid }}</strong>
                    {% endif %}
                  </span>
                </td>
                <td>
                  {% if amountPaid %}
                    <a href="{{paymentCode}}/{{amount.type}}/receipt">{{ t.penalty_details.receipt_link }}</a>
                  {% endif %}
                </td>
              </tr>
              {% for penaltyType in penaltyDetails %}
                {% if penaltyType.type == amount.type %}
                  {% if penaltyType.penalties.length == 1 %}
                    <tr {% if showPaymentButton %}class='no-border'{% endif %}>
                      <td colspan=4>
                        <strong>{{ penaltyType.penalties[0].formattedReference }}</strong>
                      </td>
                    </tr>
                  {% else %}
                    <tr {% if showPaymentButton %}class='no-border'{% endif %}>
                      <td colspan=4>
                        <details>
                          <summary><span class="summary">{{ t.penalty_details_page.penalty_details_panel_title }}</span></summary>
                          <div class="panel panel-border-narrow">
                            <table>
                              <tr>
                                <td>{{ t.penalty_details.reference }}</td>
                                <td class="numeric">{{ t.penalty_details.amount }}</td>
                              </tr>
                              {% for penalty in penaltyType.penalties %}
                                <tr>
                                  <td><strong>{{ penalty.formattedReference }}</strong></td>
                                  <td class="numeric"><strong>&pound;{{ penalty.amount }}</strong></td>
                                </tr>
                              {% endfor %}
                            </table>
                          </div>
                        </details>
                      </td>
                    </tr>
                  {% endif %}
                {% endif %}
              {% endfor %}
              {% if showPaymentButton %}
                <tr>
                  <td colspan=4>
                    {% set detailsUrl = '/payment-code/' + paymentCode + '/' + amount.type + '/details' %}
                    {{ components.button(text=t.penalty_details_page.continue_to_payment_button, url=detailsUrl) }}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          {% endif %}    
          {% if isPenaltyGroup == false %}
            <tr>
              <td>{{ t.penalty_details.reference}}:</td>
              <td>{{ penaltyDetails.formattedReference }}</td>
            </tr>
            <tr>
              <td>{{ t.penalty_details.penalty_type }}:</td>
              <td>{{ penaltyDetails.typeDescription }}</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
      <p>
        {{ components.notice(text=t.home.info_text) }}
      </p>
      {% if isPenaltyGroup == true and paymentStatus != 'PAID' %}
        <p>
          <details>
            <summary><span class="summary">{{ t.penalty_details_page.details_assistance_panel_title }}</span></summary>
            <div class="panel panel-border-narrow">
              <p>
                {{ t.penalty_details_page.details_assistance_panel_paragraph_1 }}
              </p>
              <ul>
                <li>
                  {{ t.penalty_details_page.tell_examiner }}
                </li>
                <li>
                  {{ t.penalty_details_page.call_dvsa }}
                  <br />
                  {{ components.link(text=t.penalty_details_page.call_charges_link, url='') }}
                  <br />
                  {{ t.penalty_details_page.info_needed }}
                </li>
              </ul>
            </div>
          </details>
        </p>
      {% endif %}
    {# ends components.columnTwoThirds #}
    {%- endcall %}
    {% call components.columnOneThird() %}
    <aside class="govuk-related-items" role="complementary">
        <nav role="navigation" aria-labelledby="subsection-title">
          <ul class="font-xsmall">
            <li> {{ components.link(text='French', url='?clang=fr') if clang != 'fr' else components.link(text='English', url='?clang=en') }}</li>
            <li>{{ components.link(text='German', url='?clang=de') if clang != 'de' else components.link(text='English', url='?clang=en') }}</li>
            <li>{{ components.link(text='Polish', url='?clang=pl') if clang != 'pl' else components.link(text='English', url='?clang=en') }}</li>
            <li>{{ components.link(text='Spanish', url='?clang=es') if clang != 'es' else components.link(text='English', url='?clang=en') }}</li>
            <li>{{ components.link(text='Welsh', url='?clang=cy') if clang != 'cy' else components.link(text='English', url='?clang=en') }}</li>
          </ul>
        </nav>
      </aside>
    {%- endcall %}
  {# ends components.gridRow #}
  {%- endcall %}

{% endblock %}